version: 1
applications:
  - appRoot: /
    frontend:
      phases:
        preBuild:
          commands:
            - echo "Installing dependencies..."
            - npm install -g yarn
            - yarn --frozen-lockfile
            
            # Install Doppler CLI if token is available
            - |
              if [ ! -z "$DOPPLER_TOKEN" ]; then
                echo "Installing Doppler CLI..."
                (curl -Ls https://cli.doppler.com/install.sh || wget -qO- https://cli.doppler.com/install.sh) | sh
                doppler setup --no-interactive --token $DOPPLER_TOKEN --project episode-registry --config production
              fi
              
        build:
          commands:
            - echo "Building SSR application..."
            
            # Build with Doppler if available, otherwise use env vars
            - |
              if [ ! -z "$DOPPLER_TOKEN" ]; then
                echo "Building with Doppler..."
                npx doppler run --command "yarn build:ssr"
              else
                echo "Building with environment variables..."
                yarn build:ssr
              fi
              
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .yarn/cache/**/*
          
    customHeaders:
      - pattern: "**/*"
        headers:
          - key: Strict-Transport-Security
            value: "max-age=63072000; includeSubDomains; preload"
          - key: X-Frame-Options
            value: DENY
          - key: X-Content-Type-Options
            value: nosniff
          - key: X-XSS-Protection
            value: "1; mode=block"
          - key: Content-Security-Policy
            value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cognito-idp.*.amazonaws.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.amazonaws.com wss://*.amazonaws.com"
            
      - pattern: "*.js"
        headers:
          - key: Cache-Control
            value: "public, max-age=31536000, immutable"
            
      - pattern: "*.css"
        headers:
          - key: Cache-Control
            value: "public, max-age=31536000, immutable"
            
      - pattern: "*.html"
        headers:
          - key: Cache-Control
            value: "public, max-age=0, must-revalidate"
            
    # SSR Configuration
    serverSideRendering:
      enabled: true
      runtime: nodejs18.x
      entry: server/index.js
      
    # Environment variables (will be overridden by Doppler if configured)
    environmentVariables:
      - name: NODE_ENV
        value: production
      - name: AWS_REGION
        value: eu-west-2
      - name: DDB_TABLE
        value: app_core
      - name: DDB_GSI1
        value: GSI1
      - name: DDB_GSI2
        value: GSI2